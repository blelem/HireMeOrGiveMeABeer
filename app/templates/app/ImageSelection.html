
{% extends "app/layout.html" %}
{% block content %}
{% load staticfiles %}

<div class="jumbotron">
    <h1>Select an Image Set!</h1>
    <p>
        Select the images you want to work on from the generous list below, or maybe upload your own.
    </p>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">
            Create your own image set
        </h3>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-xs-12  ">
                <!-- Add an image button -->
                <span class="btn btn-primary btn-file">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    <input type="file" multiple>
                </span>
            </div>
        </div>
        <!-- The grid of images to upload -->
        <div class="row" style="margin-top:20px" data-bind="visible: shouldShowFilesToUpload">
            <div data-bind="foreach: filesToUpload " class="tnList clearfix">
                <div class="col-xs-6 col-sm-3 tnHolder ">
                    <a href="#" class="thumbnail">
                        <img data-bind="attr: { src: image_1 }">
                    </a>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Use existing image set</h3>
    </div>
    <div class="panel-body">

        <!-- The grid of images available on the server -->

        <div class="row">
            <div data-bind="foreach: availableInputImages" class="tnList clearfix">
                <div class="col-xs-6 col-sm-3 tnHolder ">
                    <a href="#" class="thumbnail">
                        <img data-bind="attr: { src: image_1 }">
                        <br>
                        <img data-bind="attr: { src: image_2 }">
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<div style="display: none;" >
    <form id="imageUploadForm" enctype="multipart/form-data" method="post">
        {% csrf_token %}
    </form>
</div>

{% endblock %}

{% block scripts %}

<script>
// KO viewmodel
function AppViewModel() {

    var self = this;
    self.availableInputImages = ko.observableArray([
        {% for image in input_image_list %}
            { image_1 : "{{ image.thumb1 }}" , 
              image_2 : "{{ image.thumb2 }}" ,		
              pk	  : "{{ image.pk }}"  },		
        {% endfor %}
        ]);
       
    self.filesToUpload = ko.observableArray();
    self.shouldShowFilesToUpload = ko.computed(function() {
        return (self.filesToUpload().length > 0 );
    }, self);
}

// Activates knockout.js
viewModel = new AppViewModel();
ko.applyBindings(viewModel);

// Add the .clearfix to properly end one row of image.

$('.tnList >').each(function (index) {
    if (index % 4 === 1) {
        $(this).after('<div class="clearfix visible-xs-block"></div>');
    }
    if (index % 4 === 3) {
        $(this).after('<div class="clearfix"></div>');
    }
});

// When a file is selected add it to the viewModel 
$('.btn-file :file').on('change', function() {
    var input = $(this),
    numFiles = input.get(0).files ? input.get(0).files.length : 1,
    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');

    Array.prototype.forEach.call(input.get(0).files, function(fileSelected) {
        // Using FileReader to display the image content
        var reader = new FileReader(); 
        reader.onload = function(e) { 
            viewModel.filesToUpload.push({'image_1' : e.target.result });
            var fd = new FormData();
            fd.append("author", "Shiv Kumar");
            fd.append("name", "Html 5 File API/FormData");
            fd.append("fileToUpload", fileSelected);

            var csrfmiddlewaretoken = $("#imageUploadForm > input[name='csrfmiddlewaretoken']").val();
            fd.append("csrfmiddlewaretoken", csrfmiddlewaretoken);
            var xhr = new XMLHttpRequest();

          /* event listners */
           xhr.addEventListener("load", uploadComplete, false);
           xhr.addEventListener("error", uploadFailed, false);
           /* Be sure to change the url below to the url of your upload server side script */
           xhr.open("POST", "imageUpload");
           xhr.send(fd);

        };
        reader.readAsDataURL(fileSelected);
    });
});

function uploadProgress(evt) {
  if (evt.lengthComputable) {
    var percentComplete = Math.round(evt.loaded * 100 / evt.total);
    document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
  }
  else {
    document.getElementById('progressNumber').innerHTML = 'unable to compute';
  }
}

function uploadComplete(evt) {
  /* This event is raised when the server send back a response */
  alert(evt.target.responseText);
}

function uploadFailed(evt) {
  alert("There was an error attempting to upload the file.");
}

function uploadCanceled(evt) {
  alert("The upload has been canceled by the user or the browser dropped the connection.");
}  
  
 </script>
{% endblock %}
